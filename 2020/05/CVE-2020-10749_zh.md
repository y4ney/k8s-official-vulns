---CVSS 评分: [CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:C/C:L/I:L/A:L](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:C/C:L/I:L/A:L) (6.0 中危)

配置使用受影响容器网络实现的集群容易遭受中间人(MitM)攻击。通过发送"恶意"路由器通告，攻击者容器可以重新配置主机，将主机的部分或全部IPv6流量重定向到攻击者控制的容器。即使之前没有IPv6流量，如果DNS返回A(IPv4)和AAAA(IPv6)记录，许多HTTP库会优先尝试通过IPv6连接，然后回退到IPv4，这为攻击者提供了响应机会。

### 我是否受影响？

Kubernetes本身不受影响。使用受影响网络实现的Kubernetes集群存在风险。

从上游Kubernetes社区仓库(https://packages.cloud.google.com/)安装的kubelet二进制版本可能同时安装了包含[containernetworking CNI插件](https://github.com/containernetworking/plugins)的`kubernetes-cni`包，这些插件受CVE-2020-10749影响。

#### 受影响版本
以下官方kubelet软件包版本依赖的`kubernetes-cni`包受影响:
- kubelet v1.18.0-v1.18.3
- kubelet v1.17.0-v1.17.6
- kubelet < v1.16.11

只有配置使用了受影响`kubernetes-cni`包的集群才会受影响。

#### 第三方组件及版本
许多容器网络实现受影响，包括:
- containernetworking团队维护的CNI插件，0.8.6之前版本(CVE-2020-10749)(参见https://github.com/containernetworking/plugins/pull/484)
- Calico和Calico企业版(CVE-2020-13597) 详情请参阅Tigera公告TTA-2020-001 https://www.projectcalico.org/security-bulletins/
- Docker 19.03.11之前版本(参见https://github.com/docker/docker-ce/releases/v19.03.11)(CVE-2020-13401)
- Flannel，所有当前版本
- Weave Net，2.6.3之前版本

以下实现确认不受影响:
- Cilium
- Juniper Contrail Networking
- OpenShift SDN
- OVN-Kubernetes
- Tungsten Fabric

未列出插件的漏洞状态信息暂不可知。请直接联系供应商咨询其实现情况。

### 如何缓解此漏洞？
- 设置主机默认拒绝路由器通告。这可以阻止攻击成功，但可能中断合法流量(取决于网络实现和集群运行环境)。设置sysctl `net.ipv6.conf.all.accept_ra`为0。
- 使用带有正确证书验证的TLS
- 禁止不受信工作负载或用户使用`CAP_NET_RAW`。例如，在Pod安全策略的`RequiredDropCapabilities`中包含`NET_RAW`可防止受控工作负载遭受此攻击。

#### 修复版本
以下软件包将捆绑containernetworking CNI插件的修复版本(之前通过`kubernetes-cni`包安装):
- kubelet v1.19.0+(master分支 #91370)
- kubelet v1.18.4+(#91387)
- kubelet v1.17.7+(#91386)
- kubelet v1.16.11+(#91388)

由于这些版本尚未发布，使用Kubernetes仓库软件包的集群管理员可选择从containernetworking/plugins的[v0.8.6版本](https://github.com/containernetworking/plugins/releases/tag/v0.8.6)手动升级CNI插件。补丁版本[预计6月17日发布](https://github.com/kubernetes/sig-release/blob/master/releases/patch-releases.md#timelines)，时间可能有变。

## 补充细节
#### 检测方法
- 节点IPv6路由表会显示攻击者创建的条目。例如，禁用IPv6的主机执行`ip -6 route`可能不显示默认路由，但遭受攻击的主机会显示更新的默认路由或目标地址路由。任何目标接口为主机侧容器网络接口的IPv6路由都应检查。
- 接收恶意RA包后，容器网络接口的主机侧可能显示额外配置的IPv6地址。例如，主机侧接口`cbr0`通常无IPv6地址，若显示动态配置地址可能表明正在遭受攻击。使用命令查看接口地址: `ip a show dynamic cbr0`

#### 受影响配置
- 使用受影响网络实现且允许工作负载使用`CAP_NET_RAW`权限的集群。默认Kubernetes安全上下文运行的工作负载包含`CAP_NET_RAW`的能力边界集。

#### 漏洞影响
- 能在受影响集群上创建具有`CAP_NET_RAW`权限容器的用户可截获主机或其他容器的流量。

#### 致谢
此漏洞由Etienne Champetier(@champtar)报告。

修复由Casey Callendrello(@squeed)及各容器网络实现维护者完成。Kubernetes构建更新由Stephen Augustus(@justaugustus)和Tim Pepper(@tpepper)协调。

/area security
/kind bug
/committee product-security
/sig network