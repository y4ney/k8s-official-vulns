---CVSS 评分：

在典型集群中：中危 (5.4) [CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:U/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:U/C:L/I:L/A:N)

在未禁用 API Server 非安全端口的集群中：高危 (8.8) [CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)

在 `kube-proxy` 中发现一个安全问题，允许相邻主机访问绑定到节点或节点网络命名空间中 `127.0.0.1` 的 TCP 和 UDP 服务。例如，如果集群管理员在节点上运行一个监听 `127.0.0.1:1234` 的 TCP 服务，由于此漏洞，该服务可能被同一局域网内的其他主机或与服务运行在同一节点上的容器访问。如果端口 `1234` 上的示例服务不需要额外的身份验证（因为它假设只有其他本地进程可以访问它），那么它可能会受到利用此漏洞的攻击。

Kubernetes API Server 的默认非安全端口设置会导致 API Server 监听 `127.0.0.1:8080`，并在此端口上接受未经身份验证的请求。许多 Kubernetes 安装程序会显式禁用 API Server 的非安全端口，但在未禁用的集群中，攻击者如果能够访问同一局域网内的其他系统或控制运行在 master 节点上的容器，则可能访问 API Server 并在集群上执行任意 API 请求。此端口已被弃用，并将在 Kubernetes v1.20 中移除。

### 我是否受影响？

如果您满足以下条件，则可能受影响：

- 您正在运行受影响的版本（见下文）
- 您的集群节点运行在一个不受信任的主机与节点共享同一层 2 域（即同一局域网）的环境中
- 您的集群允许不受信任的 Pod 运行具有 `CAP_NET_RAW` 能力的容器（Kubernetes 默认允许此能力）
- 您的节点（或 hostnetwork Pod）运行任何仅限本地主机且不需要进一步身份验证的服务。要列出可能受影响的服务，请在节点上运行以下命令：
   - `lsof +c 15 -P -n -i4TCP@127.0.0.1 -sTCP:LISTEN`
   - `lsof +c 15 -P -n -i4UDP@127.0.0.1`

   在 master 节点上，类似以下的 `lsof` 条目表明 API Server 可能正在监听非安全端口：

```
COMMAND        PID  USER FD   TYPE DEVICE SIZE/OFF NODE NAME
kube-apiserver 123  root  7u  IPv4  26799      0t0  TCP 127.0.0.1:8080 (LISTEN)
```

#### 受影响版本
- kubelet/kube-proxy v1.18.0-1.18.3
- kubelet/kube-proxy v1.17.0-1.17.6
- kubelet/kube-proxy <=1.16.10

### 如何缓解此漏洞？
在升级之前，可以通过在节点上手动添加 iptables 规则来缓解此漏洞。此规则将拒绝非源自节点的 127.0.0.1 流量。

` iptables -I INPUT --dst 127.0.0.0/8 ! --src 127.0.0.0/8 -m conntrack ! --ctstate RELATED,ESTABLISHED,DNAT -j DROP`

此外，如果您的集群尚未禁用 API Server 的非安全端口，我们强烈建议您禁用它。在 Kubernetes API Server 命令行中添加以下标志：`--insecure-port=0`

#### 检测
网络上目标 IPv4 地址在 127.0.0.0/8 范围内且目标 MAC 地址为节点的数据包可能表明攻击正在利用此漏洞。

#### 修复版本
尽管问题由 `kube-proxy` 引起，但当前的修复在 `kubelet` 中实现（尽管未来版本可能在 `kube-proxy` 中修复）。我们建议同时升级 `kubelet` 和 `kube-proxy` 以确保问题得到解决。

以下版本包含修复：

- kubelet/kube-proxy master - 由 #91569 修复
- kubelet/kube-proxy v1.18.4+ - 由 #92038 修复
- kubelet/kube-proxy v1.17.7+ - 由 #92039 修复
- kubelet/kube-proxy v1.16.11+ - 由 #92040 修复

升级方法请参考文档：https://kubernetes.io/docs/tasks/administer-cluster/cluster-management/#upgrading-a-cluster

## 更多详情
此问题最初在 issue #90259 中提出，详细说明了 `kube-proxy` 设置 `net.ipv4.conf.all.route_localnet=1` 导致系统不拒绝源自其他主机的本地主机流量。

仅绑定到 `localhost` 地址的 IPv6 服务不受影响。

除了 #91569 及其 cherry-pick 修复的攻击途径外，可能还存在其他攻击途径。要使这些攻击成功，目标服务必须是 UDP，并且攻击只能依赖于发送 UDP 数据报，因为它不会收到任何回复。最后，目标节点需要禁用反向路径过滤才能使攻击生效。目前正在研究是否需要以及如何修复此问题。请参阅 #91666 获取此问题的最新状态。

#### 致谢
此漏洞由 Ericsson 的 János Kövér 报告，NCC Group 的 Rory McCune 以及 Palo Alto Networks 的 Yuval Avrahami 和 Ariel Zelivansky 报告了其他影响。

/area security  
/kind bug  
/committee product-security  
/sig network  
/sig node  
/area kubelet