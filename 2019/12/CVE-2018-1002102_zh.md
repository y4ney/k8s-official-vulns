---CVSS 评分: [CVSS:3.0/AV:N/AC:H/PR:H/UI:R/S:C/C:L/I:N/A:N/E:F (低)](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:H/PR:H/UI:R/S:C/C:L/I:N/A:N/E:F)

攻击者控制的 Kubelet 在响应某些 apiserver 请求时可以返回任意重定向。受影响的 kube-apiserver 会将该重定向作为 GET 请求跟随，并使用客户端证书凭证向 Kubelet 进行认证。

### 我是否受影响？

启用了 `StreamingProxyRedirects` [特性](https://kubernetes.io/docs/reference/command-line-tools-reference/feature-gates/) 且未启用 `ValidateProxyRedirects` 特性的 Kubernetes API 服务器会受到影响。

使用 SSH 隧道 (--ssh-user / --ssh-keyfile) 的 API 服务器不受影响。

使用默认特性门控值时，v1.14 之前的 kube-apiserver 版本会受到影响。

### 如何缓解此漏洞？

对于 Kubernetes 版本 >= v1.10.0，可以通过 `kube-apiserver` 标志 `--feature-gates=ValidateProxyRedirects=true` 手动启用 `ValidateProxyRedirects`。

#### 修复影响
`ValidateProxyRedirects` 特性会导致 kube-apiserver 检查重定向是否指向同一主机。如果节点配置为在与 apiserver 请求不同的主机接口上响应 CRI 流式请求（仅在不使用内置 dockershim 且设置 kubelet 标志 `--redirect-container-streaming=true` 时出现），则这些请求将被中断。在这种情况下，可以暂时禁用该特性，直到修正节点配置。我们建议在 kubelet 上设置 `--redirect-container-streaming=false` 以避免问题。

#### 已修复版本

- Kubernetes v1.14+ - 默认通过 https://github.com/kubernetes/kubernetes/pull/72552 修复
- Kubernetes v1.10-v1.14 - 通过 https://github.com/kubernetes/kubernetes/pull/66516 提供 alpha 修复

## 补充信息

在未来的版本中，我们计划弃用 `StreamingProxyRedirects` 特性，转而选择通过 Kubelet 本地处理重定向。弃用完成后，我们可以完全移除 apiserver 的重定向处理（至少对于 Kubelet 请求）。

#### 致谢

此漏洞由 Alban Crequy 报告。

/area security
/kind bug
/committee product-security
/sig api-machinery node
/area apiserver

/close