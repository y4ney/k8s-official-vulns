---[CVSS:3.0/AV:L/AC:H/PR:N/UI:N/S:U/C:L/I:L/A:L](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:L/AC:H/PR:N/UI:N/S:U/C:L/I:L/A:L)ï¼Œ4.9ï¼ˆä¸­å±ï¼‰

åœ¨ kubelet v1.13.6 å’Œ v1.14.2 ç‰ˆæœ¬ä¸­ï¼Œæœªæ˜ç¡®æŒ‡å®š `runAsUser` çš„ Pod å®¹å™¨åœ¨é‡å¯æ—¶æˆ–èŠ‚ç‚¹ä¸Šå·²å­˜åœ¨é•œåƒçš„æƒ…å†µä¸‹ï¼Œä¼šå°è¯•ä»¥ uid 0ï¼ˆrootï¼‰èº«ä»½è¿è¡Œã€‚å¦‚æœ Pod æŒ‡å®šäº† `mustRunAsNonRoot: true`ï¼Œkubelet å°†æ‹’ç»ä»¥ root èº«ä»½å¯åŠ¨å®¹å™¨ï¼›è‹¥æœªæŒ‡å®šè¯¥å‚æ•°ï¼Œkubelet ä¼šä»¥ uid 0 è¿è¡Œå®¹å™¨ã€‚

CVE-2019-11245 å°†åœ¨ä»¥ä¸‹ Kubernetes ç‰ˆæœ¬ä¸­ä¿®å¤ï¼š

* v1.13.7 é€šè¿‡ https://github.com/kubernetes/kubernetes/pull/78320
* v1.14.3 é€šè¿‡ https://github.com/kubernetes/kubernetes/pull/78316

master åˆ†æ”¯å·²é€šè¿‡ #78261 ä¿®å¤

### å—å½±å“ç»„ä»¶ï¼š

* Kubelet

### å—å½±å“ç‰ˆæœ¬ï¼š

* Kubelet v1.13.6
* Kubelet v1.14.2

### å—å½±å“é…ç½®ï¼š

æ»¡è¶³ä»¥ä¸‹æ¡ä»¶çš„é›†ç¾¤ï¼š
* ä½¿ç”¨ Kubelet v1.13.6 æˆ– v1.14.2 ç‰ˆæœ¬
* è¿è¡Œçš„ Pod æœªæ˜ç¡®æŒ‡å®š `runAsUser: <uid>` æˆ– `mustRunAsNonRoot:true`

### å½±å“ï¼š

å½“ Pod æœªåœ¨è§„èŒƒä¸­æŒ‡å®šä»»ä½•ç”¨æˆ·æ§åˆ¶å‚æ•°ï¼ˆå¦‚ `runAsUser: <uid>` æˆ– `mustRunAsNonRoot:true`ï¼‰æ—¶ï¼Œè¯¥ Pod ä¸­çš„å®¹å™¨ï¼ˆæœ¬åº”æŒ‰å®¹å™¨é•œåƒæ¸…å•ä¸­æŒ‡å®šçš„ USER è¿è¡Œï¼‰å¯èƒ½ä¼šåœ¨æŸäº›æƒ…å†µä¸‹ä»¥ root èº«ä»½è¿è¡Œï¼ˆå®¹å™¨é‡å¯æ—¶ï¼Œæˆ–èŠ‚ç‚¹ä¸Šå·²å­˜åœ¨è¯¥é•œåƒçš„æƒ…å†µï¼‰

* æ˜ç¡®æŒ‡å®š `runAsUser` çš„ Pod ä¸å—å½±å“ä¸”è¿è¡Œæ­£å¸¸
* å¼ºåˆ¶è®¾ç½® `runAsUser` çš„ podSecurityPolicies ä¸å—å½±å“ä¸”è¿è¡Œæ­£å¸¸
* æŒ‡å®š `mustRunAsNonRoot:true` çš„ Pod å°†æ‹’ç»ä»¥ uid 0 å¯åŠ¨å®¹å™¨ï¼Œå¯èƒ½å½±å“å¯ç”¨æ€§
* æœªæŒ‡å®š `runAsUser` æˆ– `mustRunAsNonRoot:true` çš„ Pod ä¼šåœ¨é‡å¯æˆ–èŠ‚ç‚¹ä¸Šå·²å­˜åœ¨é•œåƒæ—¶ä»¥ uid 0 è¿è¡Œ

### ç¼“è§£æªæ–½ï¼š

æœ¬èŠ‚åˆ—å‡ºå‡çº§å‰å¯é‡‡å–çš„ç¼“è§£æªæ–½ï¼š

* åœ¨ Pod ä¸­æŒ‡å®š `runAsUser` æŒ‡ä»¤ä»¥æ§åˆ¶å®¹å™¨çš„è¿è¡Œ uid
* åœ¨ Pod ä¸­æŒ‡å®š `mustRunAsNonRoot:true` æŒ‡ä»¤é˜²æ­¢ä»¥ root èº«ä»½å¯åŠ¨ï¼ˆæ³¨æ„åœ¨å—å½±å“çš„ kubelet ç‰ˆæœ¬ä¸Šä¼šå¯¼è‡´å®¹å™¨å¯åŠ¨å¤±è´¥ï¼‰
* æ ¹æ® Kubernetes å‘è¡Œç‰ˆæŒ‡å¯¼é™çº§ kubelet è‡³ v1.14.1 æˆ– v1.13.5

**åŸå§‹é—®é¢˜æè¿°å¦‚ä¸‹**

**é—®é¢˜ç°è±¡**ï¼š

å½“ä»æŒ‡å®šäº† Dockerfile USER çš„é•œåƒå¯åŠ¨ Pod æ—¶ï¼Œå®¹å™¨ä»…åœ¨é¦–æ¬¡å¯åŠ¨æ—¶ä»¥è¯¥ç”¨æˆ·è¿è¡Œï¼Œåç»­ä¼šä»¥ UID=0 è¿è¡Œã€‚

**é¢„æœŸè¡Œä¸º**ï¼š
æœŸæœ›å®¹å™¨æ¯æ¬¡å¯åŠ¨è¡Œä¸ºä¸€è‡´ï¼Œä¸”éµå¾ªå®¹å™¨ä¸­æŒ‡å®šçš„ USERã€‚

**é‡ç°æ­¥éª¤ï¼ˆæœ€å°åŒ–ç²¾ç¡®æ­¥éª¤ï¼‰**ï¼š
ä½¿ç”¨ minikube æµ‹è¯•ï¼ˆç›¸åŒæµ‹è¯•åœ¨ v1.14.1 ç‰ˆæœ¬ä¸­ `kubectl logs test` å§‹ç»ˆè¿”å› 11211ï¼‰ï¼š
``` 
$ minikube start --kubernetes-version v1.14.2
ğŸ˜„  minikube v1.1.0 on linux (amd64)
ğŸ’¿  Downloading Minikube ISO ...
 131.28 MB / 131.28 MB [============================================] 100.00% 0s
ğŸ”¥  Creating virtualbox VM (CPUs=2, Memory=2048MB, Disk=20000MB) ...
ğŸ³  Configuring environment for Kubernetes v1.14.2 on Docker 18.09.6
ğŸ’¾  Downloading kubeadm v1.14.2
ğŸ’¾  Downloading kubelet v1.14.2
ğŸšœ  Pulling images ...
ğŸš€  Launching Kubernetes ... 
âŒ›  Verifying: apiserver proxy etcd scheduler controller dns
ğŸ„  Done! kubectl is now configured to use "minikube"
$ cat test.yaml
---
apiVersion: v1
kind: Pod
metadata:
  name: test
spec:
  containers:
  - name: test
    image: memcached:latest
    imagePullPolicy: IfNotPresent
    command: ["/bin/bash"]
    args:
    - -c
    - 'id -u; sleep 30'
$ kubectl apply -f test.yaml 
pod/test created

# å®¹å™¨å¯åŠ¨åç«‹å³æ‰§è¡Œ
$ kubectl logs test
11211
# ç­‰å¾…30ç§’è®©å®¹å™¨é‡å¯
$ kubectl logs test
0
# å°è¯•åˆ é™¤é‡å»ºPod
$ kubectl delete pod test
pod "test" deleted
$ kubectl apply -f test.yaml 
pod/test created
$ kubectl logs test
0
```

**å…¶ä»–éœ€è¦è¯´æ˜çš„ä¿¡æ¯**ï¼š

**ç¯å¢ƒ**ï¼š
- Kubernetes ç‰ˆæœ¬ï¼ˆæ‰§è¡Œ `kubectl version`ï¼‰ï¼šv1.13.5 å’Œ v1.14.1 è¡¨ç°æ­£å¸¸ï¼Œè¯¥é—®é¢˜å­˜åœ¨äº v1.13.6 å’Œ v1.14.2
- äº‘æœåŠ¡å•†æˆ–ç¡¬ä»¶é…ç½®ï¼šminikube v1.1.0 ä½¿ç”¨ VirtualBox
- æ“ä½œç³»ç»Ÿï¼ˆæ‰§è¡Œ `cat /etc/os-release`ï¼‰ï¼š
- å†…æ ¸ç‰ˆæœ¬ï¼ˆæ‰§è¡Œ `uname -a`ï¼‰ï¼š
- å®‰è£…å·¥å…·ï¼š
- ç½‘ç»œæ’ä»¶åŠç‰ˆæœ¬ï¼ˆå¦‚æœæ˜¯ç½‘ç»œç›¸å…³é”™è¯¯ï¼‰ï¼š
- å…¶ä»–ï¼š