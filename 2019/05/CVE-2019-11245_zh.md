---[CVSS:3.0/AV:L/AC:H/PR:N/UI:N/S:U/C:L/I:L/A:L](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:L/AC:H/PR:N/UI:N/S:U/C:L/I:L/A:L)，4.9（中危）

在 kubelet v1.13.6 和 v1.14.2 版本中，未明确指定 `runAsUser` 的 Pod 容器在重启时或节点上已存在镜像的情况下，会尝试以 uid 0（root）身份运行。如果 Pod 指定了 `mustRunAsNonRoot: true`，kubelet 将拒绝以 root 身份启动容器；若未指定该参数，kubelet 会以 uid 0 运行容器。

CVE-2019-11245 将在以下 Kubernetes 版本中修复：

* v1.13.7 通过 https://github.com/kubernetes/kubernetes/pull/78320
* v1.14.3 通过 https://github.com/kubernetes/kubernetes/pull/78316

master 分支已通过 #78261 修复

### 受影响组件：

* Kubelet

### 受影响版本：

* Kubelet v1.13.6
* Kubelet v1.14.2

### 受影响配置：

满足以下条件的集群：
* 使用 Kubelet v1.13.6 或 v1.14.2 版本
* 运行的 Pod 未明确指定 `runAsUser: <uid>` 或 `mustRunAsNonRoot:true`

### 影响：

当 Pod 未在规范中指定任何用户控制参数（如 `runAsUser: <uid>` 或 `mustRunAsNonRoot:true`）时，该 Pod 中的容器（本应按容器镜像清单中指定的 USER 运行）可能会在某些情况下以 root 身份运行（容器重启时，或节点上已存在该镜像的情况）

* 明确指定 `runAsUser` 的 Pod 不受影响且运行正常
* 强制设置 `runAsUser` 的 podSecurityPolicies 不受影响且运行正常
* 指定 `mustRunAsNonRoot:true` 的 Pod 将拒绝以 uid 0 启动容器，可能影响可用性
* 未指定 `runAsUser` 或 `mustRunAsNonRoot:true` 的 Pod 会在重启或节点上已存在镜像时以 uid 0 运行

### 缓解措施：

本节列出升级前可采取的缓解措施：

* 在 Pod 中指定 `runAsUser` 指令以控制容器的运行 uid
* 在 Pod 中指定 `mustRunAsNonRoot:true` 指令防止以 root 身份启动（注意在受影响的 kubelet 版本上会导致容器启动失败）
* 根据 Kubernetes 发行版指导降级 kubelet 至 v1.14.1 或 v1.13.5

**原始问题描述如下**

**问题现象**：

当从指定了 Dockerfile USER 的镜像启动 Pod 时，容器仅在首次启动时以该用户运行，后续会以 UID=0 运行。

**预期行为**：
期望容器每次启动行为一致，且遵循容器中指定的 USER。

**重现步骤（最小化精确步骤）**：
使用 minikube 测试（相同测试在 v1.14.1 版本中 `kubectl logs test` 始终返回 11211）：
``` 
$ minikube start --kubernetes-version v1.14.2
😄  minikube v1.1.0 on linux (amd64)
💿  Downloading Minikube ISO ...
 131.28 MB / 131.28 MB [============================================] 100.00% 0s
🔥  Creating virtualbox VM (CPUs=2, Memory=2048MB, Disk=20000MB) ...
🐳  Configuring environment for Kubernetes v1.14.2 on Docker 18.09.6
💾  Downloading kubeadm v1.14.2
💾  Downloading kubelet v1.14.2
🚜  Pulling images ...
🚀  Launching Kubernetes ... 
⌛  Verifying: apiserver proxy etcd scheduler controller dns
🏄  Done! kubectl is now configured to use "minikube"
$ cat test.yaml
---
apiVersion: v1
kind: Pod
metadata:
  name: test
spec:
  containers:
  - name: test
    image: memcached:latest
    imagePullPolicy: IfNotPresent
    command: ["/bin/bash"]
    args:
    - -c
    - 'id -u; sleep 30'
$ kubectl apply -f test.yaml 
pod/test created

# 容器启动后立即执行
$ kubectl logs test
11211
# 等待30秒让容器重启
$ kubectl logs test
0
# 尝试删除重建Pod
$ kubectl delete pod test
pod "test" deleted
$ kubectl apply -f test.yaml 
pod/test created
$ kubectl logs test
0
```

**其他需要说明的信息**：

**环境**：
- Kubernetes 版本（执行 `kubectl version`）：v1.13.5 和 v1.14.1 表现正常，该问题存在于 v1.13.6 和 v1.14.2
- 云服务商或硬件配置：minikube v1.1.0 使用 VirtualBox
- 操作系统（执行 `cat /etc/os-release`）：
- 内核版本（执行 `uname -a`）：
- 安装工具：
- 网络插件及版本（如果是网络相关错误）：
- 其他：