---
<!-- 报告漏洞时请使用此模板并提供尽可能多的信息。不这样做可能导致您的漏洞无法及时处理。谢谢！

如果是安全问题，请通过 https://kubernetes.io/security/ 私下披露 -->

**我是否受影响？**

CSI 快照、克隆和扩容功能受到影响。在 Kubernetes 1.16 之前，这些功能均为 Alpha 阶段且默认禁用。从 Kubernetes 1.16 开始，CSI 克隆和扩容功能进入 Beta 阶段并默认启用。

这些功能还需要在 Kubernetes 集群中安装 CSI 驱动程序，且该 CSI 驱动程序必须支持这些功能。[此处](https://kubernetes-csi.github.io/docs/drivers.html)提供了非官方的 CSI 驱动程序列表及其支持的功能，但最好向 CSI 驱动供应商核实最新信息。

检查您是否启用了以下 Kubernetes 特性开关：

```
VolumeSnapshotDataSource: alpha starting with K8s 1.12
ExpandCSIVolumes: alpha starting with K8s 1.14, beta starting with K8s 1.16
VolumePVCDataSource: alpha starting with K8s 1.15, beta starting with K8s 1.16
```

检查您的集群是否使用了 CSI 驱动程序。如果使用，以下命令的输出将非空：

```
$ kubectl get nodes -o jsonpath='{.items[*].metadata.annotations.csi\.volume\.kubernetes\.io\/nodeid}' 
      {"my-csi-plugin":"kubernetes-minion-group-433q"}
```

然后，检查 CSI 驱动程序的 Pod 规格，查看是否使用了以下易受攻击的边车容器版本：

```
external-provisioner: v0.4.1-0.4.2, v1.0.0-1.0.1, v1.1.0-1.2.1, v1.3.0
external-snapshotter: v0.4.0-0.4.1, v1.0.0-1.0.1, v1.1.0-v1.2.1
external-resizer: v0.1.0-0.2.0
```

示例查询：
```
$ kubectl get pods --all-namespaces -o jsonpath='{..image}' | tr ' ' $'\n' | grep "csi-provisioner\|csi-snapshotter\|csi-resizer"
      image: quay.io/k8scsi/csi-provisioner:v1.2.0
```

请注意，确切的容器镜像名称可能因 CSI 驱动供应商而异。建议直接检查 Pod 规格。

**如何缓解漏洞？**

作为短期缓解措施，在 kube-apiserver 和 kube-controller-manager 中禁用 `VolumeSnapshotDataSource`、`ExpandCSIVolumes` 和 `VolumePVCDataSource` Kubernetes 特性开关。这将导致新 PersistentVolumeClaim 的配置忽略 DataSource，并且扩容请求也将被忽略。请注意，这将导致原本打算从快照或克隆配置的新 PVC 改为配置空白磁盘。

此外，要禁用卷快照功能，可以从所有 CSI 驱动程序中移除 external-snapshotter 边车容器，或撤销 CSI 驱动程序对 `snapshot.storage.k8s.io` API 组的 RBAC 权限。

长期解决方案是使用修复后的边车容器版本升级 CSI 驱动程序。以下边车容器版本已包含修复：

external-provisioner:
v0.4.3
v1.0.2
v1.2.2
v1.3.1
v1.4.0

external-snapshotter:
v0.4.2
v1.0.2
v1.2.2

external-resizer
v0.3.0

各边车容器的修复可以通过以下链接跟踪：
https://github.com/kubernetes-csi/external-provisioner/issues/380
https://github.com/kubernetes-csi/external-snapshotter/issues/193
https://github.com/kubernetes-csi/external-resizer/issues/63

**如何升级？**

请咨询您的 CSI 驱动供应商获取升级说明。除非 CSI 驱动程序捆绑在 Kubernetes 发行版中，否则不需要升级 Kubernetes 控制平面或节点。

**漏洞详情**

有两个不同的漏洞影响了相同的功能。

当 PersistentVolumeClaim 和 PersistentVolume 对象绑定时，它们彼此具有双向引用。在解引用 PersistentVolumeClaim 以获取 PersistentVolume 时，受影响的边车控制器未验证 PersistentVolume 是否反向引用相同的 PersistentVolumeClaim，可能在快照、克隆和扩容操作中对未经授权的 PersistentVolume 进行操作。

从快照创建新 PersistentVolumeClaim 时，VolumeSnapshot 和 VolumeSnapshotContent 对象也存在类似问题。

第二个问题与 CSI 卷和快照 ID 只需在单个 CSI 驱动程序中保持唯一这一特性有关。受影响的边车控制器未验证请求的源 VolumeSnapshot 或 PersistentVolumeClaim 是否来自处理请求的同一驱动程序，可能在快照、从快照恢复或克隆操作中对未经授权的卷进行操作。