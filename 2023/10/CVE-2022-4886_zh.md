---### 问题详情  
在 [ingress-nginx](https://github.com/kubernetes/ingress-nginx) 中发现一个安全漏洞：能够创建或更新 Ingress 对象的用户可利用指令绕过 Ingress 对象（属于 `networking.k8s.io` 或 `extensions` API 组）的 `spec.rules[].http.paths[].path` 字段清理机制，从而获取 ingress-nginx 控制器的凭据。在默认配置中，该凭据拥有访问集群内所有 Secret 的权限。

此漏洞评级为 **高危**（[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)），分配的 CVE 编号为 CVE-2022-4886。

### 受影响组件与配置  
该漏洞影响 ingress-nginx。若集群未安装 ingress-nginx，则不受影响。可通过运行 `kubectl get po -n ingress-nginx` 确认。

如果运行的是 v1.2.0 引入的“chrooted”模式 ingress-nginx 控制器（gcr.io/k8s-staging-ingress-nginx/controller-chroot），攻击者可执行命令但无法提取凭据，因此不适用高危评级。

允许非管理员用户创建 Ingress 对象的多租户环境受此漏洞影响最大。

#### 受影响版本  
- <v1.8.0  

#### 可缓解漏洞的版本  
- v1.8.0  

### 缓解措施  
Ingress 对象包含名为 `pathType` 的字段，用于定义代理行为，可选值为 `Exact`、`Prefix` 和 `ImplementationSpecific`。

当 `pathType` 配置为 `Exact` 或 `Prefix` 时，会启用更严格的路径验证：仅允许以 "/" 开头且仅包含字母数字字符、"-"、"_" 及额外 "/" 的路径。

启用此选项后，Admission Webhook 会执行验证，拒绝创建包含非法字符的 Ingress 对象（除非 `pathType` 为 `ImplementationSpecific`）。

https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#strict-validate-path-type  

Ingress 管理员应默认启用此验证。若因使用正则表达式/路径重写等功能仍需允许实现特定的路径，建议实施防护措施（例如通过 OPA）仅允许受信用户使用此功能：  
https://kubernetes.github.io/ingress-nginx/examples/openpolicyagent/  

### 检测  
如发现该漏洞被利用的证据，请联系 [security@kubernetes.io](mailto:security@kubernetes.io)  

### 补充说明  
详见 ingress-nginx Issue [#10570](https://github.com/kubernetes/kubernetes/issues/126815)  

### 致谢  
此漏洞由 Ginoah 通过 DEVCORE 实习计划报告。

此致  
Kubernetes 安全响应委员会代表 CJ Cullen