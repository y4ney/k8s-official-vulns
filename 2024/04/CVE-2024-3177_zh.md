---CVSS 评分：[CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:L/I:N/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:L/I:N/A:N) - **低危** (2.7)

在 Kubernetes 中发现一个安全问题：当使用带有 envFrom 字段的 containers、initContainers 和 ephemeralContainers 时，用户可能启动绕过 ServiceAccount 准入插件强制实施的挂载密钥策略的容器。该策略确保使用服务账号运行的 Pod 只能引用服务账号 secrets 字段中指定的密钥。仅当同时满足以下条件时，Kubernetes 集群会受到影响：使用 ServiceAccount 准入插件、服务账号带有 `kubernetes.io/enforce-mountable-secrets` 注解，并且使用了带有 envFrom 字段的 containers、initContainers 或 ephemeralContainers。

### 我是否受影响？

满足以下条件即存在风险：
- 集群启用了 ServiceAccount 准入插件（大多数集群默认启用，推荐配置参见 https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#serviceaccount）
- 服务账号使用了 kubernetes.io/enforce-mountable-secrets 注解（该注解默认不添加）
- Pod 使用了带有 envFrom 字段的 containers、initContainers 或 ephemeralContainers

#### 受影响版本

kube-apiserver v1.29.0 - v1.29.3  
kube-apiserver v1.28.0 - v1.28.8  
kube-apiserver <= v1.27.12  

### 如何缓解此漏洞？

可通过为 kube-apiserver 组件应用补丁来缓解此问题。该补丁会阻止带有 envFrom 字段的 containers、initContainers 和 ephemeralContainers 绕过 ServiceAccount 准入插件强制实施的挂载密钥策略。

除应用补丁外，目前没有其他已知的缓解措施。

#### 已修复版本

- kube-apiserver master - 通过 #124322 修复  
- kube-apiserver v1.29.4 - 通过 #124325 修复  
- kube-apiserver v1.28.9 - 通过 #124326 修复  
- kube-apiserver v1.27.13 - 通过 #124327 修复  

升级指南参见文档：  
https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/  

### 检测方法

利用此漏洞通过带有 envFrom 字段的 container/initContainer/ephemeralContainer 发起异常密钥访问的 Pod 更新请求会被记录在 API 审计日志中。您也可以使用以下 kubectl 命令查找正在使用 `kubernetes.io/enforce-mountable-secrets` 注解的活跃 Pod：

`kubectl get serviceaccounts --all-namespaces -o jsonpath="{range .items[?(@.metadata.annotations['kubernetes\.io/enforce-mountable-secrets']=='true')]}{.metadata.namespace}{'\t'}{.metadata.name}{'\n'}{end}"`

如发现漏洞利用证据，请联系 security@kubernetes.io  

#### 致谢

此漏洞由 tha3e1vl 报告。  

修复工作由以下成员协调完成：  
Rita Zhang @ritazh  
Joel Smith @joelsmith  
Mo Khan @enj  

以及发布经理：  
Sascha Grunert @saschagrunert  
Jeremy Rickard @jeremyrickard  

/triage accepted  
/lifecycle frozen  
/area security  
/kind bug  
/committee security-response