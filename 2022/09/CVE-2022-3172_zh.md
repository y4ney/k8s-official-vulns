---CVSS 评分: [CVSS:3.1/AV:N/AC:H/PR:H/UI:R/S:C/C:L/I:L/A:L](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:H/PR:H/UI:R/S:C/C:L/I:L/A:L) (5.1，中危)

在 kube-apiserver 中发现一个安全问题，允许聚合 API 服务器将客户端流量重定向到任意 URL。这可能导致客户端执行意外操作，并将客户端的 API 服务器凭据转发给第三方。

该问题被评为中危，并分配了 CVE-2022-3172。

### 我是否受影响？

所有运行聚合 API 服务器的以下版本 Kubernetes 集群均受影响。要确认是否配置了聚合 API 服务器，请运行以下命令：

```shell
kubectl get apiservices.apiregistration.k8s.io -o=jsonpath='{range .items[?(@.spec.service)]}{.metadata.name}{"\n"}{end}'
```

#### 受影响版本

- kube-apiserver v1.25.0
- kube-apiserver v1.24.0 - v1.24.4
- kube-apiserver v1.23.0 - v1.23.10
- kube-apiserver v1.22.0 - v1.22.13
- kube-apiserver <= v1.21.14

### 如何缓解此漏洞？

除升级外，没有直接的缓解措施。

聚合 API 服务器是 Kubernetes 控制平面的可信部分，配置它们是特权管理操作。确保仅允许受信任的集群管理员创建或修改 `APIService` 配置，并对所有可能使用的聚合 API 服务器遵循安全最佳实践。

#### 修复版本

- kube-apiserver v1.25.1 - 由 #112330 修复
- kube-apiserver v1.24.5 - 由 #112331 修复
- kube-apiserver v1.23.11 - 由 #112358 修复
- kube-apiserver v1.22.14 - 由 #112359 修复

**修复影响：** 该修复默认会阻止聚合 API 服务器的所有 3XX 响应。这可能会影响依赖重定向作为其正常功能一部分的聚合 API 服务器。如果所有当前和未来的聚合 API 服务器都被认为是可信的且需要重定向功能，请将 Kubernetes API 服务器标志 `--aggregator-reject-forwarding-redirect` 设置为 `false` 以恢复之前的行为。

升级方法请参考文档：https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade

### 检测

Kubernetes 审计日志事件通过 `responseStatus.code` 字段指示发送给客户端的 HTTP 状态码。这可用于检测聚合 API 服务器是否正在重定向客户端。

如果发现此漏洞被利用的证据，请联系 security@kubernetes.io

#### 致谢

此漏洞由 Microsoft 的 Nicolas Joly 和 Weinong Wang @weinong 报告。

该问题由 Di Jin @jindijamie @enj @liggitt @lavalamp @deads2k 和 @puerco 修复和协调。

/area security
/kind bug
/committee security-response
/label official-cve-feed
/sig api-machinery
/area apiserver
/triage accepted