---### 问题详情  
在 ingress-nginx 中发现一个安全问题：能够创建或更新 ingress 对象的用户可以利用自定义片段（custom snippets）功能获取集群中的所有 Secret。  

此问题被评级为 **高危**（[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:L/A:L](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:L/A:L)），并分配了 **CVE-2021-25742**。  

### 受影响组件与配置  
此漏洞影响 ingress-nginx。  

在非管理员用户有权创建 Ingress 对象的多租户环境中，此问题的影响最为严重。  

#### 受影响且无法缓解的版本  
- v1.0.0  
- <= v0.49.0  

#### 可缓解此问题的版本  
仅升级 ingress-nginx 无法完全修复此问题，但以下版本可通过配置缓解：  
- v1.0.1  
- v0.49.1  

### 缓解措施  
缓解此漏洞的步骤：  
1. 升级至支持缓解措施的版本（>= v0.49.1 或 >= v1.0.1）  
2. 根据部署方式，在 ingress-nginx 的 ConfigMap 中将 [allow-snippet-annotations](https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#allow-snippet-annotations) 设为 false：  

    **静态部署文件**  
    部署后编辑 ingress-nginx 的 ConfigMap：  
    ```  
    kubectl edit configmap -n ingress-nginx ingress-nginx-controller  
    ```  
    添加配置项：  
    ````  
    data:  
      allow-snippet-annotations: “false”  
     ````  
    更多 ConfigMap 信息参见[此处](https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/)  

    **通过 Helm 部署**  
    在 Values.yaml 中设置 `controller.allowSnippetAnnotations` 为 `false`，或在 Helm 部署时添加配置：  
    ```  
    helm install [RELEASE_NAME] --set controller.allowSnippetAnnotations=false ingress-nginx/ingress-nginx  
    ````  

    [参考 values.yaml 配置](https://github.com/kubernetes/ingress-nginx/blob/controller-v1.0.1/charts/ingress-nginx/values.yaml#L76)  

### 检测  
如发现此漏洞被利用的迹象，请联系 security@kubernetes.io  
更多详情参见 ingress-nginx Issue [kubernetes/kubernetes#126811](https://github.com/kubernetes/kubernetes/issues/126811)。  

### 致谢  
此漏洞由 Mitch Hulscher 报告。  

此致，  
Kubernetes 安全响应委员会  
CJ Cullen 代发