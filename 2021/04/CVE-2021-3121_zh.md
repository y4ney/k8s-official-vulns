---### 问题详情

在 Kubernetes 使用的 gogo protobuf 编译器生成的代码中发现一个安全问题。该 gogo protobuf 编译器问题被分配为 CVE-2021-3121，也被称为 "skippy peanut butter bug"。

使用受影响代码处理恶意 protobuf 消息的程序可能会出现 panic。
Kubernetes 产品安全委员会已使用恶意消息测试了 API 服务器，我们认为**对 Kubernetes 没有安全影响**。当认证用户向 API 服务器发送恶意消息时，发生了 panic。然而 panic 处理器恢复了状态，API 服务器继续运行未受影响（除了恶意请求者未收到响应外）。

生成的 protobuf 文件是多个 Kubernetes 代码库的组成部分，任何引入这些代码库的下游项目都应评估是否对其项目存在安全影响。

### 受影响组件与配置

任何使用 gogo protobuf 编译器创建的处理器代码的 golang 组件，如果这些组件接受 protobuf 消息且未优雅处理反序列化代码路径中的 panic，则可能受影响。

以下 Linux 命令可用于检测代码库中受影响的生成代码：

```
find . -name '*.pb.go' | \
xargs -r grep -l 'if skippy < 0' | \
xargs -r awk -e '/if skippy < 0/ {a=4} /if \(iNdEx \+ skippy\) > postIndex/ &&' \
  	  -e 'a>0 {print FILENAME " " FNR ": " $0 " // vulnerable to CVE-2021-3121"} {a--}'
```

尽管我们认为这对 Kubernetes 没有安全影响，出于充分谨慎考虑，并出于对可能受影响的下游使用者的礼貌，我们已更新所有生成的 protobuf。以下 PR 在 Kubernetes 中修复了此问题：

Master 分支: #98477, #101306  
1.21 分支: #98477 (在 1.21.0), #101325 (在 1.21.1)  
1.20 分支: #100501 (在 1.20.6), #101326 (在 1.20.7)  
1.19 分支: #100515 (在 1.19.10), #101327 (在 1.19.11)  
1.18 分支: #100514 (在 1.18.18), #101335 (在 1.18.19)  

对于其他生成的 protobuf go 处理器，可通过将 gogo protobuf 编译器升级到修复版本（v1.3.2 或更高版本），然后使用更新后的 protobuf 编译器重新生成受影响的 protobuf 代码来修复此问题。

### 缓解措施

禁用对 protobuf 消息的支持可能是受影响产品的一种缓解措施。

此外，在消息处理器中优雅处理 panic 也可缓解此漏洞。

### 检测方法

如果您在产品中使用生成的 protobuf 代码，并观察到进程退出时出现类似以下消息，则可能有恶意用户正在利用此缺陷：

```
panic: runtime error: index out of range [-9223372036854775804]
 
goroutine 1 [running]:
v1.(*MessageName).Unmarshal(0xc000057ef8, 0xc0000161a0, 0xa, 0x10, 0xc000057ec8, 0x1)
        .../protofile.pb.go:250 +0xb86
```

### 参考链接
- CVE-2021-3121: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-3121  
- GoGo Protobuf v1.3.2: https://github.com/gogo/protobuf/releases/tag/v1.3.2