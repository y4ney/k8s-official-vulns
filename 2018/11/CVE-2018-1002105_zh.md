---[CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H) (9.8，严重)

通过特制请求，被授权通过 Kubernetes API 服务器建立到后端服务器连接的用户，可以随后通过同一连接直接向后端发送任意请求，并使用 Kubernetes API 服务器用于建立后端连接的 TLS 凭证进行认证。

感谢 Darren Shepherd 报告此问题。

CVE-2018-1002105 已在以下 Kubernetes 版本中修复：

* [v1.10.11](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.10.md/#v11011)
* [v1.11.5](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.11.md/#v1115)
* [v1.12.3](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.12.md/#v1123)
* [v1.13.0-rc.1](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.13.md/#v1130-rc1)

### 受影响组件：

* Kubernetes API 服务器

### 受影响版本：

* Kubernetes v1.0.x-1.9.x
* Kubernetes v1.10.0-1.10.10（已在 [v1.10.11](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.10.md/#v11011) 修复）
* Kubernetes v1.11.0-1.11.4（已在 [v1.11.5](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.11.md/#v1115) 修复）
* Kubernetes v1.12.0-1.12.2（已在 [v1.12.3](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.12.md/#v1123) 修复）

注意：如果您使用的是由发行商提供的二进制文件或软件包（非开源发布产物中提供的版本），应联系发行商以确定修复此 CVE 的版本。发行商可能选择为开源项目不再维护的旧版本提供支持。

### 受影响配置：

* 运行聚合 API 服务器（如 metrics server）且该服务器可直接从 Kubernetes API 服务器网络访问的 >=1.6.x 集群。如果集群中配置了聚合 API 服务器，以下命令将返回关联的 APIService 对象名称（如果未列出名称，或 kube-apiserver 是较旧版本且没有 apiservices API，则集群未配置聚合 API 服务器）：
    ```
    kubectl get apiservices \
      -o 'jsonpath={range .items[?(@.spec.service.name!="")]}{.metadata.name}{"\n"}{end}'
    ```
* 授予 pod exec/attach/portforward 权限给不应具有 kubelet API 完全访问权限用户的 >=1.0.x 集群

### 漏洞影响：

* 对任何聚合 API 服务器端点的 API 调用可被升级为针对该聚合 API 服务器的任意 API 请求，只要该聚合 API 服务器可直接从 Kubernetes API 服务器网络访问。[默认 RBAC 策略](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#discovery-roles)允许所有用户（认证和未认证）执行发现 API 调用，从而允许对集群中配置的任何聚合 API 服务器进行此升级。
* pod exec/attach/portforward API 调用可被升级为针对 pod 规范中指定节点上 kubelet API 的任意 API 请求（例如列出节点上的所有 pod、在这些 pod 内运行任意命令并获取命令输出）。pod exec/attach/portforward 权限包含在面向命名空间受限用户的 admin/edit RBAC 角色中。

### 缓解措施：

本节列出升级前可用的缓解措施。请注意许多缓解措施可能具有破坏性，强烈建议升级到修复版本。

#### 针对匿名用户 -> 聚合 API 服务器升级的缓解措施包括：
* 暂停使用聚合 API 服务器（注意这将中断聚合服务器提供的 API 用户）
* 通过向 kube-apiserver 传递 `--anonymous-auth=false` 禁用匿名请求（注意这可能中断负载均衡器或 kubelet 对 kube-apiserver 的健康检查，并破坏 `kubeadm join` 设置流程）
* 移除对*所有*聚合 API 的*所有*匿名访问（包括由[默认发现角色绑定](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#discovery-roles)授予的发现权限）

#### 针对认证用户 -> 聚合 API 服务器升级的缓解措施包括：
* 暂停使用聚合 API 服务器（注意这将中断聚合服务器提供的 API 用户）
* 从不应具有聚合 API 完全访问权限的用户移除对*所有*聚合 API 的*所有*访问（包括由[默认发现角色绑定](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#discovery-roles)授予的发现权限）（注意这可能中断依赖发现信息将 API 类型映射到 URL 的用户和控制器）

#### 针对授权 pod exec/attach/portforward -> kubelet API 升级的缓解措施：
* 从不应具有 kubelet API 完全访问权限的用户移除 pod exec/attach/portforward 权限

### 检测：

没有简单方法可检测此漏洞是否被利用。由于未授权请求通过已建立的连接发出，它们不会出现在 Kubernetes API 服务器审计日志或服务器日志中。这些请求会出现在 kubelet 或聚合 API 服务器日志中，但与通过 Kubernetes API 服务器正确授权和代理的请求无法区分。

### 事后分析：

* [文档](https://github.com/kubernetes/kubernetes/files/2700818/PM-CVE-2018-1002105.pdf)
* [会议录像](https://youtu.be/1M4oXPgxYyE)